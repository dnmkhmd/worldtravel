<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Админ-панель — World Travel</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        body {
            background: #f0f2f5;
            min-height: 100vh;
            padding: 20px;
        }

        .admin-container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .login-screen {
            text-align: center;
            max-width: 400px;
            margin: 50px auto;
        }

        .dashboard-screen {
            display: none;
        }
    </style>
</head>

<body>

    <div class="admin-container">
        <!-- Login Screen -->
        <div id="login-screen" class="login-screen">
            <h2>Вход в админ-панель</h2>
            <form id="login-form">
                <div class="form-group">
                    <input type="password" id="password" class="input-field" placeholder="Введите пароль (admin)"
                        required>
                </div>
                <button type="submit" class="btn">Войти</button>
            </form>
        </div>

        <!-- Dashboard -->
        <div id="dashboard-screen" class="dashboard-screen">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <h2>Управление медиа</h2>
                <a href="gallery.html" target="_blank" class="btn btn-outline"
                    style="margin: 0; padding: 10px 20px;">Открыть галерею</a>
            </div>

            <!-- Upload Section -->
            <div class="glass-card" style="padding: 30px; margin-bottom: 30px; max-width: 100%;">
                <h3>Загрузить новые файлы</h3>
                <p style="margin-bottom: 20px; color: #666;">Перетащите фото или видео сюда (сохраняются локально)</p>

                <div class="upload-zone" id="drop-zone">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <h3>Перетащите файлы сюда</h3>
                    <p>или кликните для выбора</p>
                    <input type="file" id="file-input" style="display: none;" accept="image/*,video/*">
                </div>

                <div class="form-group">
                    <input type="text" id="caption-input" class="input-field"
                        placeholder="Добавить подпись (опционально)">
                </div>

                <div class="progress-container" id="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill"></div>
                    </div>
                    <p id="upload-status" style="font-size: 0.9rem; margin-top: 5px;">Обработка...</p>
                </div>
            </div>

            <h3 style="margin-bottom: 15px;">Текущая галерея</h3>
            <div class="admin-gallery-grid" id="admin-gallery">
                <!-- Items will be injected here -->
            </div>

            <button onclick="logout()" class="btn btn-outline" style="margin-top: 40px; width: 100%;">Выйти</button>
        </div>
    </div>

    <!-- IndexedDB Logic -->
    <script src="db.js"></script>

    <script>
        // --- AUTH LOGIC ---
        const loginScreen = document.getElementById('login-screen');
        const dashboardScreen = document.getElementById('dashboard-screen');

        // Simple password check
        if (localStorage.getItem('wt_admin_logged_in') === 'true') {
            showDashboard();
        }

        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const pass = document.getElementById('password').value;
            if (pass === 'admin') {
                localStorage.setItem('wt_admin_logged_in', 'true');
                showDashboard();
            } else {
                alert('Неверный пароль!');
            }
        });

        function showDashboard() {
            loginScreen.style.display = 'none';
            dashboardScreen.style.display = 'block';
            loadAdminGallery();
        }

        function logout() {
            localStorage.removeItem('wt_admin_logged_in');
            location.reload();
        }

        // --- UPLOAD LOGIC ---
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const progressContainer = document.getElementById('progress-container');
        const uploadStatus = document.getElementById('upload-status');

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            handleFiles(e.dataTransfer.files);
        });
        dropZone.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', () => handleFiles(fileInput.files));

        async function handleFiles(files) {
            if (files.length === 0) return;
            progressContainer.style.display = 'block';
            uploadStatus.innerText = "Сохранение...";

            const file = files[0];
            const caption = document.getElementById('caption-input').value || 'Без подписи';

            try {
                // Save to IndexedDB via db.js
                await addItem(file, caption);

                uploadStatus.innerText = "Успешно!";
                document.getElementById('caption-input').value = '';
                setTimeout(() => { progressContainer.style.display = 'none'; }, 1000);

                // Refresh Grid
                loadAdminGallery();

            } catch (err) {
                console.error(err);
                alert("Ошибка сохранения: " + err);
                progressContainer.style.display = 'none';
            }
        }

        // --- LOAD & DELETE LOGIC ---
        async function loadAdminGallery() {
            const grid = document.getElementById('admin-gallery');
            grid.innerHTML = '<p>Загрузка...</p>';

            try {
                const items = await getAllItems();

                if (items.length === 0) {
                    grid.innerHTML = '<p>Нет загруженных файлов</p>';
                    return;
                }

                grid.innerHTML = '';
                items.forEach((item) => {
                    const el = document.createElement('div');
                    el.className = 'admin-item';

                    // Creates a temporary Blob URL for preview
                    const url = URL.createObjectURL(item.blob);

                    let content = '';
                    if (item.type === 'video') {
                        content = `<video src="${url}" muted></video>`;
                    } else {
                        content = `<img src="${url}" alt="${item.caption}">`;
                    }

                    el.innerHTML = `
                        ${content}
                        <button class="delete-btn-overlay" onclick="removeMedia('${item.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    `;
                    grid.appendChild(el);
                });

            } catch (err) {
                console.error(err);
                grid.innerHTML = '<p>Ошибка базы данных</p>';
            }
        }

        window.removeMedia = async function (id) {
            if (!confirm("Удалить файл?")) return;
            try {
                await deleteItem(id);
                loadAdminGallery();
            } catch (e) {
                alert("Ошибка удаления: " + e);
            }
        };

    </script>
</body>

</html>